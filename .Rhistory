# Forgot to add enn_mn_forest
monthly_short_2 <- monthly %>%
filter(Year > 2013) %>%
filter(!is.na(LST_Day)) %>%
filter(!is.na(AvgRad)) %>%
filter(!is.na(EVI)) %>%
filter(!is.na(NDVI)) %>%
filter(!is.na(Precip)) %>%
filter(!is.na(SWOccurrence)) %>%
mutate(Month = (Year - 2014)*12 + Month) %>%
select(c(Code, Month, enn_mn_forest)) %>%
mutate(enn_mn_forest = ifelse(is.na(enn_mn_forest), 0,
enn_mn_forest)) %>%  # try a version removing all NAs
mutate(Code = sub("^0+", "", Code) %>% as.integer())
pb <- progress_bar$new(format = '(:spin) [:bar] :percent [Elapsed time: :elapsedfull || Estimated time remaining: :eta]',
total = unique(monthly_short_2[,'Code']) %>% nrow,
complete = '=',
incomplete = '-',
current = '>',
clear = F,
width = 100)
load('test_rwf_df_5')
h = 60 # param
test_rwf_df_8 <- test_rwf_df_5
# foreach(i = 1:(unique(monthly_short_2[,'Code']) %>% nrow())) %dopar% {
#   pb$tick()
#   foreach(j = 1:h) %dopar% {
#     test_rwf_df_8[(i-1)*h + j, 3] = (auto.arima(monthly_short_2 %>%
#                                                     filter(Code == (unique(monthly_short_2[,'Code'])[i,] %>% as.integer())) %>%
#                                                     select(c(colnames(monthly_short_2)[3])),
#                                                   seasonal = T) %>%
#                                          forecast(h = h))$mean[j]
#   }
# }
for (i in 1:(unique(monthly_short_2[,'Code']) %>% nrow)){
pb$tick()
for (j in 1:h){
test_rwf_df_8[(i-1)*h + j, 3] = (auto.arima(monthly_short_2 %>%
filter(Code == (unique(monthly_short_2[,'Code'])[i,] %>% as.integer())) %>%
select(c(colnames(monthly_short_2)[3])),
seasonal = T) %>%
forecast(h = h))$mean[j]
}
}
save(test_rwf_df_8, 'test_rwf_df_8')
1 + 1
save(test_rwf_df_8, file = 'test_rwf_df_8')
getwd()
test_rwf_df_8
test_rwf_df_9 <- test_rwf_df_8 %>%
mutate(Month = Month + 1) %>%
mutate(Month = (Year - 2020)*12 + Month - 1) %>%
filter(Total_Month == 60)
library(dplyr)
test_rwf_df_9 <- test_rwf_df_8 %>%
mutate(Month = Month + 1) %>%
mutate(Month = (Year - 2020)*12 + Month - 1) %>%
filter(Total_Month == 60)
test_rwf_df_9 <- test_rwf_df_8 %>%
mutate(Month = Month + 1) %>%
mutate(Month = (Year - 2020)*12 + Month - 1) %>%
filter(Month == 60)
test_rwf_df_9
test_rwf_df_8
test_rwf_df_9 <- test_rwf_df_8 %>%
mutate(Month = Month + 1) %>%
mutate(Month = (Year - 2020)*12 + Month - 1) %>%
filter(Month == 60)
test_rwf_df_9 <- test_rwf_df_8 %>%
mutate(Month = Month + 1) %>%
mutate(Month = (Year - 2020)*12 + Month - 1)
test_rwf_df_9
test_rwf_df_8
load(file = 'test_rwf_df_8')
test_rwf_df_8
load('test_rwf_df_5')
test_rwf_df_5
test_rwf_df_5
test_rwf_df_10 <- test_rwf_df_9 %>%
mutate(Year = test_rwf_df_5$Year)
test_rwf_df_10
test_rwf_df_9 <- test_rwf_df_8 %>%
mutate(Year = test_rwf_df_5$Year) %>%
mutate(Month = Month + 1) %>%
mutate(Month = (Year - 2020)*12 + Month - 1)
test_rwf_df_9
test_rwf_df_9
test_rwf_df_10 <- test_rwf_df_9 %>%
filter(Month == 60)
save(test_rwf_df_10, file = 'projected_input')
test_rwf_df_10
write.csv(test_rwf_df_10, file = 'projected_input.csv')
load('test_rwf_df_10')
load('projected_input')
getwd()
load(file = 'test_rwf_df_8')
test_rwf_df_8
colnames(monthly_short_2)[3]
test_rwf_df_8
names(test_rwf_df_8)
test_rwf_df_9
# library(doParallel)
# library(foreach)
# no_cores <- detectCores() - 1
# registerDoParallel(cores = no_cores)
# cl <- makeCluster(no_cores, type = "FORK")
# Forgot to add enn_mn_forest
monthly_short_2 <- monthly %>%
filter(Year > 2013) %>%
filter(!is.na(LST_Day)) %>%
filter(!is.na(AvgRad)) %>%
filter(!is.na(EVI)) %>%
filter(!is.na(NDVI)) %>%
filter(!is.na(Precip)) %>%
filter(!is.na(SWOccurrence)) %>%
mutate(Month = (Year - 2014)*12 + Month) %>%
select(c(Code, Month, enn_mn_forest)) %>%
mutate(enn_mn_forest = ifelse(is.na(enn_mn_forest), 0,
enn_mn_forest)) %>%  # try a version removing all NAs
mutate(Code = sub("^0+", "", Code) %>% as.integer())
library(dplyr)
library(forecast)
library(ggplot2)
library(seasonal)
library(urca)
library(tidyverse)
library(progress)
monthly <- read_csv('../data/monthly_df.csv')
# library(doParallel)
# library(foreach)
# no_cores <- detectCores() - 1
# registerDoParallel(cores = no_cores)
# cl <- makeCluster(no_cores, type = "FORK")
# Forgot to add enn_mn_forest
monthly_short_2 <- monthly %>%
filter(Year > 2013) %>%
filter(!is.na(LST_Day)) %>%
filter(!is.na(AvgRad)) %>%
filter(!is.na(EVI)) %>%
filter(!is.na(NDVI)) %>%
filter(!is.na(Precip)) %>%
filter(!is.na(SWOccurrence)) %>%
mutate(Month = (Year - 2014)*12 + Month) %>%
select(c(Code, Month, enn_mn_forest)) %>%
mutate(enn_mn_forest = ifelse(is.na(enn_mn_forest), 0,
enn_mn_forest)) %>%  # try a version removing all NAs
mutate(Code = sub("^0+", "", Code) %>% as.integer())
pb <- progress_bar$new(format = '(:spin) [:bar] :percent [Elapsed time: :elapsedfull || Estimated time remaining: :eta]',
total = unique(monthly_short_2[,'Code']) %>% nrow,
complete = '=',
incomplete = '-',
current = '>',
clear = F,
width = 100)
load('test_rwf_df_5')
h = 60 # param
test_rwf_df_8 <- test_rwf_df_5
# foreach(i = 1:(unique(monthly_short_2[,'Code']) %>% nrow())) %dopar% {
#   pb$tick()
#   foreach(j = 1:h) %dopar% {
#     test_rwf_df_8[(i-1)*h + j, 3] = (auto.arima(monthly_short_2 %>%
#                                                     filter(Code == (unique(monthly_short_2[,'Code'])[i,] %>% as.integer())) %>%
#                                                     select(c(colnames(monthly_short_2)[3])),
#                                                   seasonal = T) %>%
#                                          forecast(h = h))$mean[j]
#   }
# }
for (i in 1:(unique(monthly_short_2[,'Code']) %>% nrow)){
pb$tick()
for (j in 1:h){
test_rwf_df_8[(i-1)*h + j, 3] = (auto.arima(monthly_short_2 %>%
filter(Code == (unique(monthly_short_2[,'Code'])[i,] %>% as.integer())) %>%
select(c(colnames(monthly_short_2)[3])),
seasonal = T) %>%
forecast(h = h))$mean[j]
}
}
save(test_rwf_df_8, file = 'test_rwf_df_8')
load(file = 'test_rwf_df_8')
test_rwf_df_8 %>% names
test_rwf_df_8
test_rwf_df_8
colnames(monthly_short_2)[3]
test_rwf_df_8
test_rwf_df_8[,3]
test_rwf_df_8$Year
test_rwf_df_8$Year %>% summary
test_rwf_df_8$area_mn_forest %>% summary()
test_rwf_df_8 %>%
select(c(Year, area_mn_forest, te_forest, pland_forest)) %>%
summary()
aad %>% select(c(enn_mn_forest, area_mn_forest, te_forest, pland_forest)) %>%
summary()
test_rwf_df_8 %>%
select(c(Year, area_mn_forest, te_forest, pland_forest)) %>%
summary()
aad %>% select(c(enn_mn_forest, area_mn_forest, te_forest, pland_forest)) %>%
summary()
test_rwf_df_8$Year
test_rwf_df_8 %>%
select(c(Year, area_mn_forest, te_forest, pland_forest)) %>%
summary()
aad %>%
filter(!is.na(Cutaneous.Leishmaniasis)) %>%
filter(Cutaneous.Leishmaniasis > 0) %>%
select(c(enn_mn_forest, area_mn_forest, te_forest, pland_forest)) %>%
summary()
test_rwf_df_8 %>%
select(c(Year, area_mn_forest, te_forest, pland_forest)) %>%
summary()
aad %>%
filter(!is.na(Cutaneous.Leishmaniasis)) %>%
filter(Cutaneous.Leishmaniasis > 0) %>%
select(c(enn_mn_forest, area_mn_forest, te_forest, pland_forest)) %>%
summary()
test_rwf_df_9 <- test_rwf_df_8 %>%
mutate(enn_mn_forest = Year) %>%
mutate(Year = test_rwf_df_5$Year) %>%
mutate(Month = Month + 1) %>%
mutate(Month = (Year - 2020)*12 + Month - 1)
test_rwf_df_10 <- test_rwf_df_9 %>%
filter(Month == 60)
save(test_rwf_df_10, file = 'projected_input')
write.csv(test_rwf_df_10, file = 'projected_input.csv')
monthly <- read_csv('../data/monthly_df.csv')
monthly <- read_csv('../../data/monthly_df.csv')
getwd()
monthly <- read_csv(https://drive.google.com/file/d/1o4S9_WvzBMtXz4Y3VXF3bxm1oTryQefX/view?usp=sharing)
monthly <- read_csv('https://drive.google.com/file/d/1o4S9_WvzBMtXz4Y3VXF3bxm1oTryQefX/view?usp=sharing')
test_rwf_df_9 <- test_rwf_df_8 %>%
mutate(enn_mn_forest = Year) %>%
mutate(Year = test_rwf_df_5$Year) %>%
mutate(Month = Month + 1) %>%
mutate(Month = (Year - 2020)*12 + Month - 1) %>%
mutate(enn_mn_forest = enn_mn_forest + min(enn_mn_forest)) %>%
mutate(area_mn_forest = area_mn_forest + min(area_mn_forest)) %>%
mutate(te_forest = te_forest + min(te_forest)) %>%
mutate(pland_forest = pland_forest + min(pland_forest)) %>%
test_rwf_df_10 <- test_rwf_df_9 %>%
filter(Month == 60)
library(dplyr)
test_rwf_df_9 <- test_rwf_df_8 %>%
mutate(enn_mn_forest = Year) %>%
mutate(Year = test_rwf_df_5$Year) %>%
mutate(Month = Month + 1) %>%
mutate(Month = (Year - 2020)*12 + Month - 1) %>%
mutate(enn_mn_forest = enn_mn_forest + min(enn_mn_forest)) %>%
mutate(area_mn_forest = area_mn_forest + min(area_mn_forest)) %>%
mutate(te_forest = te_forest + min(te_forest)) %>%
mutate(pland_forest = pland_forest + min(pland_forest)) %>%
test_rwf_df_10 <- test_rwf_df_9 %>%
filter(Month == 60)
test_rwf_df_9 <- test_rwf_df_8 %>%
mutate(enn_mn_forest = Year) %>%
mutate(Year = test_rwf_df_5$Year) %>%
mutate(Month = Month + 1) %>%
mutate(Month = (Year - 2020)*12 + Month - 1) %>%
mutate(enn_mn_forest = enn_mn_forest + min(enn_mn_forest)) %>%
mutate(area_mn_forest = area_mn_forest + min(area_mn_forest)) %>%
mutate(te_forest = te_forest + min(te_forest)) %>%
mutate(pland_forest = pland_forest + min(pland_forest))
test_rwf_df_10 <- test_rwf_df_9 %>%
filter(Month == 60)
save(test_rwf_df_10, file = 'projected_input')
write.csv(test_rwf_df_10, file = 'projected_input.csv')
test_rwf_df_10
test_rwf_df_10%>%
select(c(Year, area_mn_forest, te_forest, pland_forest)) %>%
summary()
aad %>%
filter(!is.na(Cutaneous.Leishmaniasis)) %>%
filter(Cutaneous.Leishmaniasis > 0) %>%
select(c(enn_mn_forest, area_mn_forest, te_forest, pland_forest)) %>%
summary()
test_rwf_df_10%>%
select(c(enn_mn_forest, area_mn_forest, te_forest, pland_forest)) %>%
summary()
aad %>%
filter(!is.na(Cutaneous.Leishmaniasis)) %>%
filter(Cutaneous.Leishmaniasis > 0) %>%
select(c(enn_mn_forest, area_mn_forest, te_forest, pland_forest)) %>%
summary()
test_rwf_df_9%>%
select(c(enn_mn_forest, area_mn_forest, te_forest, pland_forest)) %>%
summary()
aad %>%
filter(!is.na(Cutaneous.Leishmaniasis)) %>%
filter(Cutaneous.Leishmaniasis > 0) %>%
select(c(enn_mn_forest, area_mn_forest, te_forest, pland_forest)) %>%
summary()
test_rwf_df_9 <- test_rwf_df_8 %>%
mutate(enn_mn_forest = Year) %>%
mutate(Year = test_rwf_df_5$Year) %>%
mutate(Month = Month + 1) %>%
mutate(Month = (Year - 2020)*12 + Month - 1) %>%
mutate(enn_mn_forest = enn_mn_forest - min(enn_mn_forest)) %>%
mutate(area_mn_forest = area_mn_forest - min(area_mn_forest)) %>%
mutate(te_forest = te_forest - min(te_forest)) %>%
mutate(pland_forest = pland_forest - min(pland_forest))
test_rwf_df_10 <- test_rwf_df_9 %>%
filter(Month == 60)
save(test_rwf_df_10, file = 'projected_input')
write.csv(test_rwf_df_10, file = 'projected_input.csv')
test_rwf_df_10 %>%
select(c(enn_mn_forest, area_mn_forest, te_forest, pland_forest)) %>%
summary()
aad %>%
filter(!is.na(Cutaneous.Leishmaniasis)) %>%
filter(Cutaneous.Leishmaniasis > 0) %>%
select(c(enn_mn_forest, area_mn_forest, te_forest, pland_forest)) %>%
summary()
test_rwf_df_8 %>%
select(c(Year, area_mn_forest, te_forest, pland_forest)) %>%
summary()
aad %>%
filter(!is.na(Cutaneous.Leishmaniasis)) %>%
filter(Cutaneous.Leishmaniasis > 0) %>%
select(c(enn_mn_forest, area_mn_forest, te_forest, pland_forest)) %>%
summary()
test_rwf_df_8 %>%
select(c(Year, area_mn_forest, te_forest, pland_forest)) %>%
summary()
aad %>%
filter(!is.na(Cutaneous.Leishmaniasis)) %>%
filter(Cutaneous.Leishmaniasis > 0) %>%
select(c(enn_mn_forest, area_mn_forest, te_forest, pland_forest)) %>%
summary()
monthly
monthly
monthly_short
monthly_short %>%
filter(Code == sample(Code, 1))
monthly_short_2
graph_df <- monthly_short %>%
filter(Code == sample(Code, 1)) %>%
mutate(Month = (Year - 2014 + 1)*Month + Month) %>%
mutate(enn_mn_forest = monthly_short_2$enn_mn_forest) %>%
select(c(Month, enn_mn_forest, te_forest, pland_forest, area_mn_forest))
monthly_short
monthly_short %>% dim()
monthly_short_2 %>% dim()
graph_df <- monthly_short %>%
filter(Code == sample(Code, 1)) %>%
mutate(Month = (Year - 2014 + 1)*Month + Month) %>%
mutate(enn_mn_forest = monthly_short_2$enn_mn_forest) %>%
select(c(Month, enn_mn_forest, te_forest, pland_forest, area_mn_forest))
graph_df <- monthly_short %>%
mutate(Month = (Year - 2014 + 1)*Month + Month) %>%
mutate(enn_mn_forest = monthly_short_2$enn_mn_forest) %>%
select(c(Month, enn_mn_forest, te_forest, pland_forest, area_mn_forest)) %>%
filter(Code == sample(Code, 1))
graph_df <- monthly_short %>%
mutate(Month = (Year - 2014 + 1)*Month + Month) %>%
mutate(enn_mn_forest = monthly_short_2$enn_mn_forest) %>%
filter(Code == sample(Code, 1)) %>%
select(c(Month, enn_mn_forest, te_forest, pland_forest, area_mn_forest))
ggplot(graph_df) +
geom_point(aes(x = Month,
color = c(enn_mn_forest,
te_forest,
pland_forest,
area_mn_forest)))
ggplot(graph_df) +
geom_point(aes(x = Month,
y = c(enn_mn_forest,
te_forest,
pland_forest,
area_mn_forest)))
y = enn_mn_forest)
ggplot(graph_df) +
geom_point(aes(x = Month,
y = enn_mn_forest))
graph_df
graph_df <- monthly_short %>%
mutate(Month = (Year - 2014 + 1) + Month) %>%
mutate(enn_mn_forest = monthly_short_2$enn_mn_forest) %>%
filter(Code == sample(Code, 1)) %>%
select(c(Month, enn_mn_forest, te_forest, pland_forest, area_mn_forest))
ggplot(graph_df) +
geom_point(aes(x = Month,
y = enn_mn_forest))
graph_df
ggplot(graph_df) +
geom_point(aes(x = Month,
y = enn_mn_forest)) +
geom_point(aes(x = Month,
y = te_forest))
library(reshape)
graph_df_long <- graph_df %>% melt(id = 'Month',
measure = c('enn_mn_forest',
'te_forest',
'pland_forest',
'area_mn_forest'))
graph_df_long <- melt(graph_df,
id = 'Month',
measure = c('enn_mn_forest',
'te_forest',
'pland_forest',
'area_mn_forest'))
graph_df %>% names
knitr::opts_chunk$set(echo = T,
cache = F,
eval = T,
results = 'show',
warning = F,
message = F)
load('../../extrapolation/projected_input')
set.seed(123)
library(tidyverse)
library(tidymodels)
library(stacks)
library(dplyr)
load('../../extrapolation/projected_input')
data <- test_rwf_df_10
data_res <-
data %>%
bind_cols(predict(model_st_40,.))
model_st_40$coefs
model_st_40$outcome
model_st_40$model_defs
model_st_40
model_st_40$member_fits
model_st_40$mode
load('model_stacks/TEMP_model_st_later_CL_classif_40')
data %>% names
data_res <-
data %>%
bind_cols(predict(model_st_40,.))
data %>% names
data <- test_rwf_df_10 %>%
select(c(colnames('LST_Day', 'Year',
'NDVI', 'EVI', 'Precip',
'AvgRad', 'SWOccurrence', 'pland_forest',
'te_forest', 'enn_mn_forest','Population')))
data <- test_rwf_df_10 %>%
select(c('LST_Day', 'Year',
'NDVI', 'EVI', 'Precip',
'AvgRad', 'SWOccurrence', 'pland_forest',
'te_forest', 'enn_mn_forest','Population'))
data_res <-
data %>%
bind_cols(predict(model_st_40,.))
data %>% colnames
load('model_stacks/FINAL_model_st_later_CL_classif_40')
data_res <-
data %>%
bind_cols(predict(model_st_40,.))
data_res <-
predict(model_st_40,data))
data_res <-
predict(model_st_40,data)
load('data_tests/TEMP_data_test_later_CL_classif_40')
data_test_40
load('data_stacks/TEMP_data_st_later_CL_classif_40')
data_st_40
data_st_40$.pred_1_nb_res_1_1
# helper packages
library(tidyverse)
library(tidymodels)
library(stacks)
# load and split the early data using imputed data
load('../../data/imp')
aad <- read.csv('../data/aad.csv')
quantile_data <- data %>%
filter(!is.na(Cutaneous.Leishmaniasis)) %>%
filter(Cutaneous.Leishmaniasis > 0) %>%
dplyr::select(Cutaneous.Leishmaniasis)
quantile <- (quantile_data$Cutaneous.Leishmaniasis %>%
quantile(0.4))[[1]] # PARAMETER
data <- data %>%
filter(Year >= 2014) %>%
filter(!is.na(Cutaneous.Leishmaniasis)) %>%
filter(Cutaneous.Leishmaniasis > 0) %>%
dplyr::select(c('Cutaneous.Leishmaniasis', 'LST_Day', 'Year', # include LST_Night?
'NDVI', 'EVI', 'Precip',
'AvgRad', 'SWOccurrence', 'pland_forest',
'te_forest', 'enn_mn_forest','Population'))
data$pland_forest <- ifelse(is.na(data$pland_forest), 0, data$pland_forest)
data$te_forest <- ifelse(is.na(data$te_forest), 0, data$te_forest)
data$enn_mn_forest <- ifelse(is.na(data$enn_mn_forest), 0, data$enn_mn_forest)
data$Cutaneous.Leishmaniasis <- as.factor(ifelse(data$Cutaneous.Leishmaniasis < quantile, 0, 1))
set.seed(123) # for reproducibility
aad <- aad %>%
filter(Year >= 2014) %>%
filter(!is.na(Cutaneous.Leishmaniasis)) %>%
filter(Cutaneous.Leishmaniasis > 0)
split <- initial_split(data)
data_train <- training(split)
data_test_40_temp <- testing(split)
data_test_40 <-  (aad %>%
select(c(colnames(data_test_40_temp))))[Index_temp,] %>%
subset(!is.na(LST_Day)) %>%
subset(!is.na(SWOccurrence))
data_test_40
data_test_40$pland_forest <- ifelse(is.na(data_test_40$pland_forest), 0, data_test_40$pland_forest)
data_test_40$te_forest <- ifelse(is.na(data_test_40$te_forest), 0, data_test_40$te_forest)
data_test_40$enn_mn_forest <- ifelse(is.na(data_test_40$enn_mn_forest), 0, data_test_40$enn_mn_forest)
data_test_40$Cutaneous.Leishmaniasis <- as.factor(ifelse(data_test_40$Cutaneous.Leishmaniasis < quantile, 0, 1))
data_test_40 %>% dim
set.seed(123)
library(tidyverse)
library(tidymodels)
library(stacks)
library(dplyr)
load('../../extrapolation/projected_input')
data <- test_rwf_df_10 %>%
select(c('LST_Day', 'Year',
'NDVI', 'EVI', 'Precip',
'AvgRad', 'SWOccurrence', 'pland_forest',
'te_forest', 'enn_mn_forest','Population'))
data_test_40 %>% dim
data %>% dim
